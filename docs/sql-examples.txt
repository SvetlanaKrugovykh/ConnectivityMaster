SELECT 
    source_ip,
    timestamp::date AS day,
    COUNT(*) AS attempts
FROM traffic_data
WHERE destination_port = 445
  AND timestamp >= current_date - INTERVAL '1 day'
GROUP BY source_ip, day
ORDER BY day DESC, attempts DESC;

====================================

SELECT 
    destination_port,
    timestamp::date AS day,
    COUNT(*) AS attempts
FROM traffic_data
WHERE source_ip = '192.168.58.1'
  AND timestamp >= current_date - INTERVAL '2 day'
GROUP BY destination_port, day
ORDER BY day DESC, attempts DESC;
=====================================


(
    SELECT
        'SCAN_PORTS' AS threat_type,
        source_ip,
        COUNT(DISTINCT destination_ip) AS uniq_dst_ips,
        COUNT(DISTINCT destination_port) AS uniq_dst_ports,
        COUNT(*) AS attempts
    FROM traffic_data
    WHERE timestamp >= current_date - INTERVAL '1 day'
    GROUP BY source_ip
    HAVING COUNT(DISTINCT destination_ip) > 500
        OR COUNT(DISTINCT destination_port) > 100
)

UNION ALL

(
    SELECT
        'SUSPICIOUS_PORTS' AS threat_type,
        source_ip,
        COUNT(DISTINCT destination_ip) AS uniq_dst_ips,
        COUNT(DISTINCT destination_port) AS uniq_dst_ports,
        COUNT(*) AS attempts
    FROM traffic_data
    WHERE timestamp >= current_date - INTERVAL '1 day'
      AND destination_port IN (135, 139, 445, 1433, 3389, 5900)
    GROUP BY source_ip
    HAVING COUNT(*) > 50
)

UNION ALL

(
    SELECT
        'SMTP_SPAM' AS threat_type,
        source_ip,
        COUNT(DISTINCT destination_ip) AS uniq_dst_ips,
        COUNT(DISTINCT destination_port) AS uniq_dst_ports,
        COUNT(*) AS attempts
    FROM traffic_data
    WHERE timestamp >= current_date - INTERVAL '1 day'
      AND destination_port IN (25, 465, 587)
    GROUP BY source_ip
    HAVING COUNT(*) > 20
)

UNION ALL

(
    SELECT
        'BURST_TRAFFIC' AS threat_type,
        source_ip,
        COUNT(DISTINCT destination_ip) AS uniq_dst_ips,
        COUNT(DISTINCT destination_port) AS uniq_dst_ports,
        COUNT(*) AS attempts
    FROM traffic_data
    WHERE timestamp >= current_date - INTERVAL '1 day'
    GROUP BY source_ip
    HAVING COUNT(*) > 5000
)

ORDER BY attempts DESC;
